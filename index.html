<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Astronomická předpověď</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; transition: background-color 0.3s; }
    tr:hover { background-color: #f1f1f1; }
    .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: flex-start; flex-wrap: wrap; }
    .input-container { position: relative; width: 300px; }
    .input-container input[type="text"] { width: 100%; padding: 8px 30px 8px 10px; box-sizing: border-box; }
    .clear-button { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 18px; cursor: pointer; color: #888; display: none; }
    .clear-button:hover { color: #000; }
    #suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0px 4px 8px rgba(0,0,0,0.1); display: none; }
    #suggestions li { list-style: none; padding: 10px; cursor: pointer; transition: background-color 0.2s; }
    #suggestions li:hover, #suggestions li.active { background-color: #007bff; color: white; }
    button { padding: 8px 12px; }
    .low-cloud { background-color: #d4edda; }
    .medium-cloud { background-color: #fff3cd; }
    .high-cloud { background-color: #f8d7da; }
    .day-row { background-color: #e2e3e5; font-weight: bold; text-align: left; cursor: pointer; }
    .day-cell { text-align: left; padding-left: 10px; border-bottom: 2px solid #000; }
    .time-emoji { background-color: #66b2ff; border-radius: 6px; padding: 4px; display: inline-block; color: white; box-shadow: 0 0 4px rgba(0, 0, 0, 0.3); font-size: 90%; min-width: 30px; min-height: 30px; line-height: 22px; text-align: center; }
    .night-emoji { background-color: #003366; }
    .hidden-row { display: none; }
    #loading-spinner { display: none; font-size: 18px; margin-bottom: 10px; }
  </style>
</head>
<body>

<h1>Astronomická předpověď</h1>
<h2 id="cityDisplay"></h2>
<div id="loading-spinner">⏳ Načítám...</div>

<div class="controls">
  <div class="input-container">
    <input type="text" id="cityInput" placeholder="Zadejte město (např. Praha)" oninput="autocompleteCities()" onkeydown="handleSuggestionKeys(event)" autocomplete="off">
    <button class="clear-button" id="clearButton" onclick="clearInput()">×</button>
    <ul id="suggestions"></ul>
  </div>
  <button id="gpsButton" onclick="getLocation()">📍</button>
  <button onclick="manualSearch()">Zobrazit předpověď</button>
</div>

<table id="forecast">
  <thead>
    <tr>
      <th>🕒 Čas</th>
      <th>🌗 Den/Noc</th>
      <th>🌡️ Teplota (°C)</th>
      <th>☁️ Oblačnost (%)</th>
      <th>🌧️ Srážky (mm)</th>
      <th>💨 Vítr (km/h)</th>
      <th>🌙 Fáze Měsíce</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let sunriseTimes = {}, sunsetTimes = {}, cityOptions = [], selectedSuggestion = -1;

function getDayName(dateString) {
  const date = new Date(dateString);
  const dayName = date.toLocaleDateString('cs-CZ', { weekday: 'long' });
  return dayName.charAt(0).toUpperCase() + dayName.slice(1);
}

function getSimpleTimeEmoji(hour, dateStr) {
  const sunriseHour = sunriseTimes[dateStr] ? parseInt(sunriseTimes[dateStr].split(":")[0], 10) : 6;
  const sunsetHour = sunsetTimes[dateStr] ? parseInt(sunsetTimes[dateStr].split(":")[0], 10) : 18;
  if (hour >= sunriseHour - 1 && hour <= sunriseHour + 1) return '🌅';
  else if (hour > sunriseHour + 1 && hour < sunsetHour - 1) return '🌞';
  else if (hour >= sunsetHour - 1 && hour <= sunsetHour + 1) return '🌇';
  else return '🌙';
}

function getMoonPhaseEmoji(date) {
  const lp = 2551443; // moon period in seconds
  const now = new Date(date);
  const new_moon = new Date(2001,0,24,13,35);
  const phase = ((now.getTime() - new_moon.getTime()) / 1000) % lp;
  const age = Math.floor(phase / (24*3600));
  if (age < 1) return '🌑';
  else if (age < 7) return '🌒';
  else if (age < 14) return '🌓';
  else if (age < 21) return '🌔';
  else if (age < 28) return '🌕';
  else return '🌑';
}

async function autocompleteCities() {
  const input = document.getElementById('cityInput');
  const query = input.value.trim();
  const suggestions = document.getElementById('suggestions');
  const clearBtn = document.getElementById('clearButton');
  suggestions.innerHTML = '';
  selectedSuggestion = -1;

  if (query.length === 0) {
    suggestions.style.display = 'none';
    clearBtn.style.display = 'none';
    return;
  }

  clearBtn.style.display = 'block';

  if (query.length < 3) {
    suggestions.style.display = 'none';
    return;
  }

  const response = await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(query)}&format=json&limit=5`);
  const results = await response.json();
  cityOptions = results;

  if (results.length === 0) {
    suggestions.style.display = 'none';
    return;
  }

  results.forEach((result, index) => {
    const li = document.createElement('li');
    li.textContent = result.display_name;
    li.addEventListener('click', () => {
      selectCity(index);
    });
    suggestions.appendChild(li);
  });
  suggestions.style.display = 'block';
}

function handleSuggestionKeys(e) {
  const suggestions = document.getElementById('suggestions');
  const items = suggestions.querySelectorAll('li');

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (selectedSuggestion < items.length - 1) selectedSuggestion++;
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (selectedSuggestion > 0) selectedSuggestion--;
  } else if (e.key === 'Enter' && selectedSuggestion >= 0) {
    e.preventDefault();
    items[selectedSuggestion].click();
    return;
  }

  items.forEach((item, idx) => {
    item.classList.toggle('active', idx === selectedSuggestion);
  });
}

function selectCity(index) {
  const choice = cityOptions[index];
  document.getElementById('cityInput').value = choice.display_name;
  document.getElementById('cityDisplay').innerText = choice.display_name;
  document.getElementById('suggestions').style.display = 'none';
  document.getElementById('clearButton').style.display = 'block';
  fetchForecast(choice.lat, choice.lon);
}

function clearInput() {
  document.getElementById('cityInput').value = '';
  document.getElementById('suggestions').style.display = 'none';
  document.getElementById('clearButton').style.display = 'none';
}

function manualSearch() {
  const query = document.getElementById('cityInput').value.trim();
  if (!query) {
    alert('Zadejte název města.');
    return;
  }
  autocompleteCities().then(() => {
    if (cityOptions.length > 0) {
      selectCity(0);
    } else {
      alert('Město nenalezeno.');
    }
  });
}

async function fetchForecast(lat, lon) {
  try {
    document.getElementById('loading-spinner').style.display = 'block';
    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,cloudcover,precipitation,windspeed_10m&daily=sunrise,sunset&timezone=Europe/Prague`);
    if (!response.ok) throw new Error('HTTP chyba: ' + response.status);
    const data = await response.json();

    sunriseTimes = {}, sunsetTimes = {};
    (data.daily.sunrise || []).forEach(sun => { const [d, t] = sun.split('T'); sunriseTimes[d] = t; });
    (data.daily.sunset || []).forEach(sun => { const [d, t] = sun.split('T'); sunsetTimes[d] = t; });

    const { time: times = [], temperature_2m: temps = [], cloudcover: clouds = [], precipitation: rain = [], windspeed_10m: wind = [] } = data.hourly || {};
    const tbody = document.querySelector('#forecast tbody');
    tbody.innerHTML = '';

    let currentDay = '';
    let group = 0;

    for (let i = 0; i < Math.min(times.length, 168); i++) {
      const [datePart, timePart] = times[i]?.split('T') || ['',''];
      const dayName = getDayName(datePart);
      const hour = parseInt(timePart?.split(':')[0], 10);
      const emoji = getSimpleTimeEmoji(hour, datePart);
      const moonEmoji = getMoonPhaseEmoji(datePart);

      if (dayName !== currentDay) {
        currentDay = dayName;
        group++;

        const sunriseText = sunriseTimes[datePart] ? `Východ slunce ${sunriseTimes[datePart]}` : 'N/A';
        const sunsetText = sunsetTimes[datePart] ? `Západ slunce ${sunsetTimes[datePart]}` : 'N/A';

        const dayRow = document.createElement('tr');
        dayRow.className = 'day-row';
        dayRow.innerHTML = `<td colspan="7" class="day-cell" onclick="toggleDay(this, ${group})">▶️ 📅 ${dayName} - ${sunriseText} / ${sunsetText}</td>`;
        tbody.appendChild(dayRow);
      }

      let cloudClass = '';
      if (clouds[i] <= 30) cloudClass = 'low-cloud';
      else if (clouds[i] <= 70) cloudClass = 'medium-cloud';
      else cloudClass = 'high-cloud';

      const row = document.createElement('tr');
      row.className = `${cloudClass.trim()} group-${group}`;
      row.innerHTML = `
        <td>🕒 ${timePart}</td>
        <td>${emoji}</td>
        <td>🌡️ ${temps[i] ?? 'N/A'}</td>
        <td>☁️ ${clouds[i] ?? 'N/A'}</td>
        <td>🌧️ ${rain[i] ?? 'N/A'}</td>
        <td>💨 ${wind[i] ?? 'N/A'}</td>
        <td>${moonEmoji}</td>
      `;
      tbody.appendChild(row);
    }
  } catch (error) {
    console.error('Chyba při načítání předpovědi:', error);
    alert('Nepodařilo se načíst předpověď.');
  } finally {
    document.getElementById('loading-spinner').style.display = 'none';
  }
}

function toggleDay(cell, group) {
  const rows = document.querySelectorAll(`.group-${group}`);
  rows.forEach(row => row.classList.toggle('hidden-row'));
  cell.innerHTML = cell.innerHTML.includes('▶️') ? cell.innerHTML.replace('▶️', '🔽') : cell.innerHTML.replace('🔽', '▶️');
}

function getLocation() {
  const loading = document.getElementById('loading-spinner');
  loading.style.display = 'block';
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async (position) => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
        const data = await response.json();
        if (data.address && data.address.city) {
          document.getElementById('cityInput').value = data.address.city;
          document.getElementById('cityDisplay').innerText = data.address.city;
          document.getElementById('clearButton').style.display = 'block';
          fetchForecast(lat, lon);
        } else {
          alert('Nepodařilo se zjistit město podle polohy.');
        }
      } catch (error) {
        console.error('Chyba při získávání města z polohy:', error);
        alert('Chyba při získávání města.');
      } finally {
        loading.style.display = 'none';
      }
    }, () => {
      alert('Nelze zjistit polohu.');
      loading.style.display = 'none';
    });
  } else {
    alert('Geolokace není podporována tímto prohlížečem.');
    loading.style.display = 'none';
  }
}

document.addEventListener('click', (e) => {
  if (!document.querySelector('.input-container').contains(e.target)) {
    document.getElementById('suggestions').style.display = 'none';
  }
});
</script>

</body>
</html>
