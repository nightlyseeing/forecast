<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Astronomická předpověď - Vyhledávání měst</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; transition: background-color 0.3s; }
    tr:hover { background-color: #f1f1f1; }
    th { background-color: #f4f4f4; position: sticky; top: 0; }
    .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
    .low-cloud { background-color: #d4edda; }
    .medium-cloud { background-color: #fff3cd; }
    .high-cloud { background-color: #f8d7da; }
    .day-row { background-color: #e2e3e5; font-weight: bold; text-align: left; cursor: pointer; }
    .day-cell { text-align: left; padding-left: 10px; border-bottom: 2px solid #000; }
    .time-emoji {
      background-color: #66b2ff;
      border-radius: 6px;
      padding: 4px;
      display: inline-block;
      color: white;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
      font-size: 90%;
      min-width: 30px;
      min-height: 30px;
      line-height: 22px;
      text-align: center;
    }
    .night-emoji { background-color: #003366; }
    .hidden-row { display: none; }
    #gpsButton { cursor: pointer; background: none; border: none; font-size: 24px; }
  </style>
</head>
<body>
  <h1>Astronomická předpověď</h1>
  <h2 id="cityDisplay"></h2>

  <div class="controls">
    <input type="text" id="cityInput" placeholder="Zadejte město (např. Praha)">
    <button id="gpsButton" onclick="getLocation()">📍</button>
    <button onclick="searchCityAndFetchForecast()">Zobrazit předpověď</button>
  </div>

  <table id="forecast">
    <thead>
      <tr>
        <th>🕒 Čas</th>
        <th>🌗 Den/Noc</th>
        <th>🌡️ Teplota (°C)</th>
        <th>☁️ Oblačnost (%)</th>
        <th>🌧️ Srážky (mm)</th>
        <th>💨 Vítr (km/h)</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

<script>
  let sunriseTimes = {};
  let sunsetTimes = {};
  let currentCity = '';

  function getDayName(dateString) {
    const date = new Date(dateString);
    const dayName = date.toLocaleDateString('cs-CZ', { weekday: 'long' });
    return dayName.charAt(0).toUpperCase() + dayName.slice(1);
  }

  function getSimpleTimeEmoji(hour, dateStr) {
    const sunriseHour = sunriseTimes[dateStr] ? parseInt(sunriseTimes[dateStr].split(":")[0], 10) : 6;
    const sunsetHour = sunsetTimes[dateStr] ? parseInt(sunsetTimes[dateStr].split(":")[0], 10) : 18;

    if (hour >= sunriseHour - 1 && hour <= sunriseHour + 1) {
      return '<span class="time-emoji">🌅</span>';
    } else if (hour > sunriseHour + 1 && hour < sunsetHour - 1) {
      return '<span class="time-emoji">🌞</span>';
    } else if (hour >= sunsetHour - 1 && hour <= sunsetHour + 1) {
      return '<span class="time-emoji">🌇</span>';
    } else {
      return '<span class="time-emoji night-emoji">🌙</span>';
    }
  }

  async function searchCityAndFetchForecast() {
    const city = document.getElementById('cityInput').value.trim();
    if (!city) {
      alert('Zadejte název města.');
      return;
    }
    currentCity = city;
    document.getElementById('cityDisplay').innerText = city;
    try {
      const geoResponse = await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(city)}&format=json&limit=1`);
      const geoData = await geoResponse.json();
      if (!geoData.length) {
        alert('Město nenalezeno.');
        return;
      }
      const latitude = geoData[0].lat;
      const longitude = geoData[0].lon;
      fetchForecast(latitude, longitude);
    } catch (error) {
      console.error('Chyba při hledání města:', error);
      alert('Nepodařilo se najít město.');
    }
  }

  async function fetchForecast(lat, lon) {
    try {
      const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,cloudcover,precipitation,windspeed_10m&daily=sunrise,sunset&timezone=Europe/Prague`);
      if (!response.ok) {
        throw new Error('HTTP chyba: ' + response.status);
      }
      const data = await response.json();

      if (!data.hourly || !data.daily) {
        throw new Error('Neplatná struktura dat z API.');
      }

      (data.daily.sunrise || []).forEach((sun) => {
        const [date, time] = sun.split('T');
        sunriseTimes[date] = time;
      });

      (data.daily.sunset || []).forEach((sun) => {
        const [date, time] = sun.split('T');
        sunsetTimes[date] = time;
      });

      const times = data.hourly.time || [];
      const temps = data.hourly.temperature_2m || [];
      const clouds = data.hourly.cloudcover || [];
      const rain = data.hourly.precipitation || [];
      const wind = data.hourly.windspeed_10m || [];

      const tbody = document.querySelector('#forecast tbody');
      tbody.innerHTML = '';

      let currentDay = '';
      let group = 0;

      for (let i = 0; i < Math.min(times.length, 72); i++) {
        const [datePart, timePart] = times[i]?.split('T') || ['',''];
        const dayName = getDayName(datePart);
        const hour = parseInt(timePart?.split(':')[0], 10);
        const emoji = getSimpleTimeEmoji(hour, datePart);

        if (dayName !== currentDay) {
          currentDay = dayName;
          group++;
          const dayRow = document.createElement('tr');
          dayRow.className = 'day-row';
          dayRow.innerHTML = `<td colspan="6" class="day-cell" onclick="toggleDay(this, ${group})">▶️ 📅 ${currentDay} - 🌅 ${sunriseTimes[datePart] || 'N/A'} / 🌇 ${sunsetTimes[datePart] || 'N/A'}</td>`;
          tbody.appendChild(dayRow);
        }

        let cloudClass = '';
        if (clouds[i] <= 30) cloudClass = 'low-cloud';
        else if (clouds[i] <= 70) cloudClass = 'medium-cloud';
        else cloudClass = 'high-cloud';

        const row = document.createElement('tr');
        row.className = `${cloudClass.trim()} group-${group}`;
        row.innerHTML = `
          <td>🕒 ${timePart}</td>
          <td>${emoji}</td>
          <td>🌡️ ${temps[i] ?? 'N/A'}</td>
          <td>☁️ ${clouds[i] ?? 'N/A'}</td>
          <td>🌧️ ${rain[i] ?? 'N/A'}</td>
          <td>💨 ${wind[i] ?? 'N/A'}</td>
        `;
        tbody.appendChild(row);
      }
    } catch (error) {
      console.error('Chyba při načítání předpovědi:', error);
      alert('Nepodařilo se načíst předpověď.');
    }
  }

  function toggleDay(cell, group) {
    const rows = document.querySelectorAll(`.group-${group}`);
    rows.forEach(row => row.classList.toggle('hidden-row'));
    cell.innerHTML = cell.innerHTML.includes('▶️') ? cell.innerHTML.replace('▶️', '🔽') : cell.innerHTML.replace('🔽', '▶️');
  }

  async function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
          const data = await response.json();
          if (data.address && data.address.city) {
            document.getElementById('cityInput').value = data.address.city;
            document.getElementById('cityDisplay').innerText = data.address.city;
            fetchForecast(lat, lon);
          } else {
            alert('Nepodařilo se zjistit město podle polohy.');
          }
        } catch (error) {
          console.error('Chyba při získávání města z polohy:', error);
          alert('Chyba při získávání města.');
        }
      }, () => {
        alert('Nelze zjistit polohu.');
      });
    } else {
      alert('Geolokace není podporována tímto prohlížečem.');
    }
  }
</script>

</body>
</html>
